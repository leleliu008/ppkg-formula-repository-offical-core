summary: Cryptography and SSL/TLS Toolkit
git-url: https://github.com/openssl/openssl
web-url: https://www.openssl.org/
src-url: https://www.openssl.org/source/openssl-3.1.1.tar.gz
src-sha: b3aa61334233b852b63ddb048df181177c2c659eb9d4376008118f9c08d07674
license: Apache-2.0
dep-pkg: perl

bsystem: gmake
binbstd: yes
install: |
    case $NATIVE_OS_KIND in
        openbsd) sed -i 's|-Wl,-z,defs||' Configurations/shared-info.pl
    esac

    # if -static option is given, only static libs are created, but we want both static and shared libs, so we remove the -static option
    if printf '%s\n' "$LDFLAGS" | grep -q '\-static' ; then
        export LDFLAGS="$(printf '%s\n' "$LDFLAGS" | sed -e 's|--static||g' -e 's|-static||g')"
        #sed_in_place 's|BIN_EX_LIBS=|BIN_EX_LIBS=-static |' Configurations/unix-Makefile.tmpl
    fi

    if [ "$LINK_TYPE" = static-only ] || [ "$LINK_TYPE" = static-prefered ] ; then
        cat > proxy-ld.c <<EOF
    #include <stdio.h>
    #include <stdlib.h>
    #include <string.h>
    #include <unistd.h>

    int main(int argc, char* argv[]) {
        for (int i = 1; i < argc; i++) {
            if (strcmp(argv[i], "-lssl") == 0) {
                argv[i] = (char*)"./libssl.a";
            } else if (strcmp(argv[i], "-lcrypto") == 0) {
                argv[i] = (char*)"./libcrypto.a";
            } else {
                #ifndef NATIVE_OS_KIND_DARWIN
                if (strcmp(argv[i], "-fPIC") == 0) {
                    argv[i] = (char*)"-static";
                }
                #endif
            }
        }

        char * LD = getenv("CC");

        argv[0] = LD;

        for (int i = 0; i < argc; i++) {
            printf("%s ", argv[i]);
        }

        printf("\n");

        execv(LD, argv);

        perror(LD);

        return 127;
    }
    EOF
        if [ "$NATIVE_OS_KIND" = darwin ] ; then
            run $CC $CPPFLAGS $CFLAGS $LDFLAGS -std=c99 -DNATIVE_OS_KIND_DARWIN -o proxy-ld proxy-ld.c
        else
            run $CC $CPPFLAGS $CFLAGS $LDFLAGS -std=c99 -UNATIVE_OS_KIND_DARWIN -o proxy-ld proxy-ld.c
        fi

        run export LDCMD=./proxy-ld
    fi

    run ./config \
        no-tests \
        no-ssl2 \
        no-ssl3 \
        no-comp \
        --prefix=$PACKAGE_INSTALL_DIR  \
        --libdir=$PACKAGE_INSTALL_DIR/lib \
        --openssldir=$PACKAGE_INSTALL_DIR/etc/ssl &&
    gmakew clean &&
    gmakew &&
    gmakew install
