summary: Cryptography and SSL/TLS Toolkit
git-url: https://github.com/openssl/openssl
web-url: https://www.openssl.org/
src-url: https://www.openssl.org/source/openssl-3.1.3.tar.gz
src-sha: f0316a2ebd89e7f2352976445458689f80302093788c466692fb2a188b2eacf6
license: Apache-2.0
dep-upp: perl
bsystem: gmake

prepare: |
    if [ "$TARGET_PLATFORM_NAME" = openbsd ] ; then
        sed -i 's|-Wl,-z,defs||' Configurations/shared-info.pl

        if isCrossBuild ; then
            export LDFLAGS="$LDFLAGS -fuse-ld=lld"
            CONFIG_ARGS="$CONFIG_ARGS no-devcryptoeng"
        fi
    fi

    unset OS_COMPILER

    case $TARGET_PLATFORM_NAME in
        linux)
            case $TARGET_PLATFORM_ARCH in
                riscv64) OS_COMPILER='linux64-riscv64' ;;
                *)       OS_COMPILER="linux-$TARGET_PLATFORM_ARCH"
            esac
            ;;
        macos)
            OS_COMPILER="darwin64-$TARGET_PLATFORM_ARCH"
            ;;
        *bsd)
            case $TARGET_PLATFORM_ARCH in
                amd64)  OS_COMPILER='BSD-x86_64' ;;
                *)      OS_COMPILER="BSD-$TARGET_PLATFORM_ARCH"
            esac
    esac

# https://github.com/openssl/openssl/blob/master/INSTALL.md
install: |
    run ./Configure \
        no-engine \
        no-tests \
        no-ssl2 \
        no-ssl3 \
        no-comp \
        no-asm \
        no-hw \
        --prefix="$PACKAGE_INSTALL_DIR" \
        --libdir=$PACKAGE_INSTALL_DIR/lib \
        "$os_compiler"
    gmakew clean
    gmakew CROSS_COMPILE=
    gmakew CROSS_COMPILE= install
